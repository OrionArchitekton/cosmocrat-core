version: "3.9"

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_USER: ${PG_USER}
      POSTGRES_DB: ${PG_DB}
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d ${PG_DB}"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  langfuse:
    image: ghcr.io/langfuse/langfuse:latest
    environment:
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      DATABASE_URL: postgres://${PG_USER}:${PG_PASSWORD}@postgres:5432/${PG_DB}
      NEXT_PUBLIC_SIGNUP_DISABLED: "true"
    depends_on:
      - postgres
    ports:
      - "3000:3000"

  edge-orchestrator:
    build: ./app/services/edge-orchestrator
    environment:
      PG_URL: postgres://${PG_USER}:${PG_PASSWORD}@postgres:5432/${PG_DB}
      REDIS_URL: redis://redis:6379/0
      LANGFUSE_HOST: http://langfuse:3000
      CH_HTTP_URL: ${CH_HTTP_URL}
    depends_on:
      - postgres
      - redis
      - langfuse
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS localhost:8000/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      - "8000:8000"

  confirm-engine:
    build: ./app/services/confirm-engine
    environment:
      PG_URL: postgres://${PG_USER}:${PG_PASSWORD}@postgres:5432/${PG_DB}
      REDIS_URL: redis://redis:6379/1
      LANGFUSE_HOST: http://langfuse:3000
      CH_HTTP_URL: ${CH_HTTP_URL}
    depends_on:
      - postgres
      - redis
      - edge-orchestrator
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS localhost:8010/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      - "8010:8010"

  deploy-memory:
    build: ./app/services/deploy-memory
    environment:
      PG_URL: postgres://${PG_USER}:${PG_PASSWORD}@postgres:5432/${PG_DB}
      REDIS_URL: redis://redis:6379/2
      CH_HTTP_URL: ${CH_HTTP_URL}
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS localhost:8020/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    ports:
      - "8020:8020"

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    profiles: ["analytics"]
    environment:
      CLICKHOUSE_DB: orion
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - ch_data:/var/lib/clickhouse
      - ch_logs:/var/log/clickhouse-server
    ports:
      - "8123:8123"
      - "9000:9000"

  n8n:
    image: n8nio/n8n:latest
    profiles: ["automation"]
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASS:-change-me}
      - N8N_HOST=localhost
      - N8N_PROTOCOL=http
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n

  appsmith:
    image: appsmith/appsmith-ce
    profiles: ["cockpit"]
    ports:
      - "8580:80"
      - "8443:443"
    volumes:
      - appsmith_stacks:/appsmith-stacks

volumes:
  pg_data:
  redis_data:
  ch_data:
  ch_logs:
  n8n_data:
  appsmith_stacks:
